name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      run: |
        gh release create ${{ github.ref_name }} \
          --title "Release ${{ steps.get_version.outputs.version }}" \
          --notes "## Changes
          
          See [CHANGELOG.md](https://github.com/fireboy1919/mise-s3-cache/blob/main/CHANGELOG.md) for details.
          
          ## Installation
          
          ### Using cargo
          \`\`\`bash
          cargo install mise-s3-cache
          \`\`\`
          
          ### Download binary
          Download the appropriate binary for your platform from the assets below.
          
          ### Checksums
          SHA256 checksums are provided for all binaries."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release:
    name: Build Release
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x64
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            name: linux-x64-musl
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-arm64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x64
            ext: .exe
          - target: x86_64-apple-darwin
            os: macos-latest
            name: macos-x64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: macos-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross-compilation tools
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Install cross-compilation tools (ARM)
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: release-${{ matrix.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}
      env:
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

    - name: Strip binary (Linux and macOS)
      if: matrix.os != 'windows-latest'
      run: |
        if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
          aarch64-linux-gnu-strip target/${{ matrix.target }}/release/s3-cache
        else
          strip target/${{ matrix.target }}/release/s3-cache
        fi

    - name: Create archive
      shell: bash
      run: |
        binary_name="s3-cache${{ matrix.ext || '' }}"
        archive_name="s3-cache-${{ needs.create-release.outputs.version }}-${{ matrix.name }}"
        
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          7z a "${archive_name}.zip" "./target/${{ matrix.target }}/release/${binary_name}"
          echo "ASSET=${archive_name}.zip" >> $GITHUB_ENV
        else
          tar czf "${archive_name}.tar.gz" -C "target/${{ matrix.target }}/release" "${binary_name}"
          echo "ASSET=${archive_name}.tar.gz" >> $GITHUB_ENV
        fi

    - name: Generate checksum
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          sha256sum "${ASSET}" > "${ASSET}.sha256"
        else
          shasum -a 256 "${ASSET}" > "${ASSET}.sha256"
        fi

    - name: Upload Release Assets
      run: |
        gh release upload ${{ needs.create-release.outputs.version }} \
          "${{ env.ASSET }}" \
          "${{ env.ASSET }}.sha256"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    name: Publish to crates.io
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: publish-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  update-brew:
    name: Update Homebrew Formula
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.create-release.outputs.version, '-') }} # Only for non-prerelease versions
    steps:
    - name: Update Homebrew formula
      uses: dawidd6/action-homebrew-bump-formula@v3
      with:
        token: ${{ secrets.HOMEBREW_TOKEN }}
        formula: mise-s3-cache