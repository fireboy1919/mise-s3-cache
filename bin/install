#!/bin/bash
# mise-s3-cache plugin install script

set -e

PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/.."
LIB_DIR="$PLUGIN_DIR/lib"

source "$LIB_DIR/config.sh"
source "$LIB_DIR/s3-cache.sh"
source "$LIB_DIR/utils.sh"

# This plugin doesn't install a traditional tool
# Instead, it sets up the S3 cache system
main() {
    local tool_name="$1"
    local tool_version="$2"
    local install_path="$3"
    
    log_info "Setting up S3 cache system..."
    
    # Validate S3 configuration
    if ! validate_s3_config; then
        log_error "S3 cache configuration invalid"
        exit 1
    fi
    
    # Create cache directory structure
    mkdir -p "$install_path/bin"
    mkdir -p "$install_path/lib"
    mkdir -p "$install_path/config"
    
    # Copy scripts to install path
    cp -r "$PLUGIN_DIR/lib"/* "$install_path/lib/"
    cp -r "$PLUGIN_DIR/scripts"/* "$install_path/bin/"
    cp "$PLUGIN_DIR/config/cache.conf" "$install_path/config/"
    
    # Make scripts executable
    chmod +x "$install_path/bin"/*
    chmod +x "$install_path/lib"/*.sh
    
    # Test S3 connectivity
    if test_s3_access; then
        log_success "S3 cache setup complete and tested"
    else
        log_warn "S3 cache setup complete but connectivity test failed"
    fi
    
    # Add mise hooks
    setup_mise_hooks
    
    log_info "S3 cache is now active for this project"
}

setup_mise_hooks() {
    local hooks_dir="$HOME/.config/mise/hooks"
    mkdir -p "$hooks_dir"
    
    # Create pre-install hook
    cat > "$hooks_dir/pre-install" << 'EOF'
#!/bin/bash
# S3 cache pre-install hook

TOOL_NAME="$1"
TOOL_VERSION="$2"

# Check if s3-cache plugin is installed
S3_CACHE_PATH="$(mise where s3-cache 2>/dev/null || echo "")"
if [[ -n "$S3_CACHE_PATH" && -x "$S3_CACHE_PATH/bin/cache-check" ]]; then
    "$S3_CACHE_PATH/bin/cache-check" "$TOOL_NAME" "$TOOL_VERSION"
fi
EOF
    chmod +x "$hooks_dir/pre-install"
    
    # Create post-install hook
    cat > "$hooks_dir/post-install" << 'EOF'
#!/bin/bash
# S3 cache post-install hook

TOOL_NAME="$1"
TOOL_VERSION="$2"
INSTALL_PATH="$3"

# Check if s3-cache plugin is installed
S3_CACHE_PATH="$(mise where s3-cache 2>/dev/null || echo "")"
if [[ -n "$S3_CACHE_PATH" && -x "$S3_CACHE_PATH/bin/cache-store" ]]; then
    "$S3_CACHE_PATH/bin/cache-store" "$TOOL_NAME" "$TOOL_VERSION" "$INSTALL_PATH" &
fi
EOF
    chmod +x "$hooks_dir/post-install"
    
    log_success "Mise hooks installed"
}

main "$@"